<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
<meta charset="UTF-8" />
<title>CIS-CSM Exam 2</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body { background:#fff; }
  .option-card { cursor:pointer; transition:.15s; }
  .option-card:not(.disabled):hover { border-color:#6f42c1; box-shadow:0 0 0 .15rem rgba(111,66,193,.15); }
  .option-card.selected { border-width:2px; border-color:#6f42c1; background:#f9f5ff; }
  .option-card.correct-user, .option-card.correct { border-color:#198754!important; background:#d1e7dd; }
  .option-card.incorrect-user { border-color:#dc3545!important; background:#f8d7da; }
  .badge-label { font-size:.65rem; letter-spacing:.5px; text-transform:uppercase; font-weight:600; }
  .feedback-area { animation:fadeIn .35s; }
  @keyframes fadeIn { from {opacity:0;transform:translateY(4px)} to {opacity:1;transform:translateY(0)} }
  .donut-wrapper { position:relative; width:160px; height:160px; margin:auto; }
  .donut-wrapper canvas { width:100%; height:100%; }
  .donut-center { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:1.3rem; }
  .question-header-mini { font-size:.8rem; color:#6c757d; text-transform:uppercase; letter-spacing:.5px; }
  .toggle-theme { position:fixed; bottom:1rem; right:1rem; z-index:1000; }
  .question-status-alert { font-size:.8rem; }

  /* Matching */
  .matching-row {
    display:flex;
    gap:1rem;
    align-items:flex-start;
    padding:.75rem .9rem;
    border:1px solid #dee2e6;
    border-radius:.5rem;
    margin-bottom:.6rem;
    background:#fff;
  }
  .matching-row select { min-width:150px; }
  .matching-row.correct { border-color:#198754; background:#d1e7dd; }
  .matching-row.incorrect { border-color:#dc3545; background:#f8d7da; }
  .matching-left-text { flex:1; }
  .matching-badge {
    font-size:.6rem;
    letter-spacing:.5px;
    font-weight:600;
    text-transform:uppercase;
  }
  @media (max-width: 576px){
    .matching-row { flex-direction:column; }
    .matching-row select { width:100%; }
  }
</style>
</head>
<body>
<div class="container py-4" id="appRoot"></div>
<button class="btn btn-outline-secondary btn-sm toggle-theme" id="themeBtn" title="Alternar Tema">üåì</button>

<script>
/* ==============================
 * CONFIG
 * ============================== */
const HIDE_OPTION_IDS = true; // Se quiser voltar a mostrar IDs (A., B., 1-, etc.) mude para false.

/* ==============================
 * QUEST√ïES (JSON BASE) - exemplo incluindo matching
 * ============================== */
const QUESTIONS_BANK_RAW = [
  {
    "id": 1,
    "type": "single",
    "question": "Which feature enables you to quickly identify high-priority tasks based on multiple dimensions, not just by a single field value like priority?",
    "options": [
      { "id": "A", "text": "Case Performance", "correct": false },
      { "id": "B", "text": "Case Analytics", "correct": false },
      { "id": "C", "text": "Case Digest", "correct": false },
      { "id": "D", "text": "Case Spotlight", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 2,
    "type": "single",
    "question": "During which Now Create stage are workshops conducted?",
    "options": [
      { "id": "A", "text": "Execute", "correct": false },
      { "id": "B", "text": "Initiate", "correct": false },
      { "id": "C", "text": "Deliver", "correct": false },
      { "id": "D", "text": "Plan", "correct": true },
      { "id": "E", "text": "Close", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 3,
    "type": "single",
    "question": "Which application must be activated to enable customers to check in on-line for future appointments?",
    "options": [
      { "id": "A", "text": "Business Location", "correct": false },
      { "id": "B", "text": "Walk-Up Experience", "correct": true },
      { "id": "C", "text": "Field Service Management", "correct": false },
      { "id": "D", "text": "Service Organization", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 4,
    "type": "multiple",
    "question": "What are some of the influencing factors that will help determine the type of customer support desk structure required? (Choose four.)",
    "options": [
      { "id": "A", "text": "Knowledge and skills required for agents", "correct": true },
      { "id": "B", "text": "Geographical location of customer", "correct": true },
      { "id": "C", "text": "Languages spoken by agents", "correct": true },
      { "id": "D", "text": "Number and type of support tools available", "correct": false },
      { "id": "E", "text": "Number of customer service portals used", "correct": false },
      { "id": "F", "text": "Number of agents required", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 5,
    "type": "single",
    "question": "What is the default value in the Channel field when a new case is opened by a customer in the Service Catalog, using the Customer Service Portal?",
    "options": [
      { "id": "A", "text": "Web", "correct": true },
      { "id": "B", "text": "Catalog", "correct": false },
      { "id": "C", "text": "Portal", "correct": false },
      { "id": "D", "text": "Virtual Agent", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 6,
    "type": "single",
    "question": "When activating the Customer Service Management Demo Data plugin, which case type is available besides product case?",
    "options": [
      { "id": "A", "text": "Order", "correct": true },
      { "id": "B", "text": "Contract", "correct": false },
      { "id": "C", "text": "FAQ", "correct": false },
      { "id": "D", "text": "Monitoring", "correct": false },
      { "id": "E", "text": "Request", "correct": false },
      { "id": "F", "text": "Billing", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 7,
    "type": "single",
    "question": "What's the purpose of the Deactivate Special Handling Notes Scheduled Job?",
    "options": [
      { "id": "A", "text": "Runs at the end of the month and deactivates all Special Handling notes more than 30 days old", "correct": false },
      { "id": "B", "text": "Runs weekly and must have the Active checkbox unchecked in order for Special Handling notes to be deleted by the end of the week", "correct": false },
      { "id": "C", "text": "Runs on demand by the System Admin who must set specific weekly schedules and set only those that are priority 1-critical to be deactivated", "correct": false },
      { "id": "D", "text": "Runs daily at midnight, checks all active alerts and sets the status to Expired for those that have reached their expiration dates", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 8,
    "type": "single",
    "question": "What does the Agent Whisper function do?",
    "options": [
      { "id": "A", "text": "Lets agents and chat supervisors have a conversation without the requester knowing", "correct": true },
      { "id": "B", "text": "Lets the chat supervisors have a conversation with the requester without the agent knowing", "correct": false },
      { "id": "C", "text": "Lets agents have chat conversations with other agents without the requester knowing", "correct": false },
      { "id": "D", "text": "Lets agents and requesters have a conversation without the chat supervisor knowing", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 9,
    "type": "multiple",
    "question": "Upon self-registration through the Consumer Service Portal, a record is created in: (Choose two.)",
    "options": [
      { "id": "A", "text": "Contact (customer_contact)", "correct": false },
      { "id": "B", "text": "Consumer User (csm_consumer-user)", "correct": true },
      { "id": "C", "text": "Consumer (csm_consumer)", "correct": true },
      { "id": "D", "text": "CSM User (csm_user)", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 10,
    "type": "multiple",
    "question": "Who can create a customer service case from a community discussion? (Choose two.)",
    "options": [
      { "id": "A", "text": "Customer service agent (sn_customerservice_agent)", "correct": true },
      { "id": "B", "text": "Proxy case creator (sn_customerservice.proxy_case_creator)", "correct": true },
      { "id": "C", "text": "Partner (sn_customerservice.partner)", "correct": false },
      { "id": "D", "text": "Case Viewer (sn_customerservice.case_viewer)", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 11,
    "type": "multiple",
    "question": "The assignment workbench uses configurable matching criteria to evaluate agents in a selected group and provide an overall ranking. What are the different types of criteria available for the assignment workbench? (Choose three.)",
    "options": [
      { "id": "A", "text": "Correlation", "correct": false },
      { "id": "B", "text": "Availability", "correct": false },
      { "id": "C", "text": "Scripted", "correct": true },
      { "id": "D", "text": "Simple Match", "correct": true },
      { "id": "E", "text": "Aggregate", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 12,
    "type": "multiple",
    "question": "Asset classes are defined to allow for logical grouping of assets. There are five asset classes provided to group assets, each Asset class provides unique functionality for that group of Assets in the platform. Which of the following are the asset classes used? (Choose five.)",
    "options": [
      { "id": "A", "text": "Hardware assets", "correct": true },
      { "id": "B", "text": "Facility assets", "correct": true },
      { "id": "C", "text": "Configuration assets", "correct": false },
      { "id": "D", "text": "Software licenses assets", "correct": true },
      { "id": "E", "text": "Enterprise Software assets", "correct": true },
      { "id": "F", "text": "Network assets", "correct": false },
      { "id": "G", "text": "Consumables assets", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 13,
    "type": "single",
    "question": "Which of the following best describes how the CSM application uses the Asset table?",
    "options": [
      { "id": "A", "text": "CSM uses the Product table instead of the ITSM Asset table", "correct": false },
      { "id": "B", "text": "CSM uses the Product Model table instead of the ITSM Asset table", "correct": false },
      { "id": "C", "text": "ServiceNow uses the same Asset table for both CSM and ITSM, however CSM has a different subset of fields", "correct": true },
      { "id": "D", "text": "Because CSM Assets are managed differently from ITSM Assets ServiceNow uses different Asset Tables for CSM than it does for ITSM", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 14,
    "type": "single",
    "question": "A consumer service agent receives and accepts a case which was created by a consumer. The agent needs and requests more information from the consumer. After receiving the information, the agent proposes a solution that is accepted by the consumer. Given this scenario, what is the chronological order of case states used to manage this case?",
    "options": [
      { "id": "A", "text": "New > Work in Progress > On Hold > Work in Progress > Resolved > Closed", "correct": false },
      { "id": "B", "text": "New > Open > Work in Progress > Solution Proposed > Closed", "correct": false },
      { "id": "C", "text": "Open > Pending > Work in Progress > Resolved > Closed", "correct": false },
      { "id": "D", "text": "New > Open > Awaiting Info > Open > Resolved > Closed", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 15,
    "type": "multiple",
    "question": "What are the types of matching criteria for Customer Service? (Choose four.)",
    "options": [
      { "id": "A", "text": "Matching Skills", "correct": true },
      { "id": "B", "text": "Last Assigned", "correct": true },
      { "id": "C", "text": "Certifications", "correct": false },
      { "id": "D", "text": "Distance", "correct": false },
      { "id": "E", "text": "Assigned Cases", "correct": true },
      { "id": "F", "text": "Availability Today", "correct": true },
      { "id": "G", "text": "Partner Hours", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 16,
    "type": "single",
    "question": "What is a supported external customer that, in turn, sells to and supports one or more customers?",
    "options": [
      { "id": "A", "text": "Partner", "correct": true },
      { "id": "B", "text": "Account", "correct": false },
      { "id": "C", "text": "Contact", "correct": false },
      { "id": "D", "text": "Consumer", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 17,
    "type": "single",
    "question": "Customer Service Trending Topics is a capability that enables companies to use Predictive Intelligence to quickly pinpoint factors driving up case volume and act to mitigate them. Which of the following would be a benefit of using Predictive Intelligence Customer Service Trending Topics?",
    "options": [
      { "id": "A", "text": "Eliminate the need for more traditional performance analytics", "correct": false },
      { "id": "B", "text": "Auto-generate clusters of cases that point to similar underlying issues", "correct": true },
      { "id": "C", "text": "Create root cause solutions for similar cases", "correct": false },
      { "id": "D", "text": "A guaranteed reduction in call volume per month", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 18,
    "type": "multiple",
    "question": "Which ServiceNow applications can be integrated out-of-the-box with CSM? (Choose three.)",
    "options": [
      { "id": "A", "text": "Service Portfolio Management", "correct": true },
      { "id": "B", "text": "Project Management", "correct": true },
      { "id": "C", "text": "DevOps", "correct": false },
      { "id": "D", "text": "Risk Management", "correct": false },
      { "id": "E", "text": "ITOM Event Management", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 19,
    "type": "multiple",
    "question": "Which of the following are benefits that may be gained from using communities? (Choose three.)",
    "options": [
      { "id": "A", "text": "Reduce support costs", "correct": true },
      { "id": "B", "text": "Engagement with Customers", "correct": true },
      { "id": "C", "text": "Get product feedback", "correct": true },
      { "id": "D", "text": "Reduce cost per sales", "correct": false },
      { "id": "E", "text": "Increase marketing effectiveness", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 20,
    "type": "single",
    "question": "What is a case?",
    "options": [
      { "id": "A", "text": "An individual record that handles and resolves incidents for external customers", "correct": false },
      { "id": "B", "text": "An individual record that is used to identify and create automation opportunities", "correct": false },
      { "id": "C", "text": "An individual record that is used to identify and resolve a question or issue for an external customer", "correct": true },
      { "id": "D", "text": "An individual record that handles and routes issues for internal users", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 21,
    "type": "single",
    "question": "External content integration is important for agents to be able to access knowledge articles from external sources. ALL external sources must be:",
    "options": [
      { "id": "A", "text": "WebDAV-versioned", "correct": false },
      { "id": "B", "text": "Web-configurable", "correct": false },
      { "id": "C", "text": "WebDAV-compliant", "correct": true },
      { "id": "D", "text": "Web-based", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 22,
    "type": "multiple",
    "question": "An Account Relationship is based on a defined account relationship type. Users with the System Administrator role can define two types of relationships: (Choose two.)",
    "options": [
      { "id": "A", "text": "Partner-to-customer", "correct": false },
      { "id": "B", "text": "Account-to-customer", "correct": false },
      { "id": "C", "text": "Account-to-account", "correct": true },
      { "id": "D", "text": "Customer-to-Consumer", "correct": false },
      { "id": "E", "text": "Partner-to-account", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 23,
    "type": "single",
    "question": "Which knowledge records can be configured with User Criteria?",
    "options": [
      { "id": "A", "text": "Knowledge Base", "correct": false },
      { "id": "B", "text": "Knowledge Base and Category", "correct": false },
      { "id": "C", "text": "Knowledge Base, Category and Article", "correct": false },
      { "id": "D", "text": "Knowledge Base and Article", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 24,
    "type": "multiple",
    "question": "When the virtual agent plugin is installed NLU is activated but is not available for use until what two configurations are completed? (Choose two.)",
    "options": [
      { "id": "A", "text": "Choose the NLU service provider", "correct": true },
      { "id": "B", "text": "In the NLU Settings configure the Intent confidence threshold", "correct": false },
      { "id": "C", "text": "Enable NLU in Virtual Agent", "correct": true },
      { "id": "D", "text": "In the NLU Settings configure the Entity confidence threshold", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 25,
    "type": "multiple",
    "question": "An entitlement defines the types of support a customer receives. Entitlements are based on a number of standard fields such as product and asset. When Proactive Customer Service Operations is implemented which additional fields could be used? (Choose two.)",
    "options": [
      { "id": "A", "text": "Contact", "correct": false },
      { "id": "B", "text": "Configuration Item", "correct": false },
      { "id": "C", "text": "Business Service", "correct": false },
      { "id": "D", "text": "Install base item", "correct": true },
      { "id": "E", "text": "Sold product", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 26,
    "type": "single",
    "question": "When implementing Knowledge Product Entitlements, what is enabled when activating the Enable access control of Knowledge Articles system property?",
    "options": [
      { "id": "A", "text": "Allows access to knowledge articles based on customer's security access", "correct": false },
      { "id": "B", "text": "Allows access to knowledge articles that are related to entitlements owned by a customer", "correct": false },
      { "id": "C", "text": "Allows access to multi-product line knowledge articles", "correct": false },
      { "id": "D", "text": "Allows access to knowledge articles that are related to products owned by a customer", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 27,
    "type": "multiple",
    "question": "Advance Work Assignment assigns work to agents based on their availability, capacity, and skills. Agent Affinity enhances the Advanced Work Assignment process by adding additional agent details organized by affinity type. Which of these are these affinity types? (Choose three.)",
    "options": [
      { "id": "A", "text": "Skill seniority", "correct": false },
      { "id": "B", "text": "Account team responsibility", "correct": true },
      { "id": "C", "text": "Historical", "correct": true },
      { "id": "D", "text": "Related task", "correct": true },
      { "id": "E", "text": "Product expertise", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 28,
    "type": "single",
    "question": "In Agent Workspace Chat, Agents have the ability to use quick actions to work more efficiently. What action does the /r quick action perform?",
    "options": [
      { "id": "A", "text": "Rejects an incoming chat and moves it automatically to the \"General\" queue", "correct": false },
      { "id": "B", "text": "Routes the chat towards another group", "correct": false },
      { "id": "C", "text": "Uses response templates to insert as text in a conversation", "correct": true },
      { "id": "D", "text": "Rolls up the current chat history towards an existing case", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 29,
    "type": "single",
    "question": "Name a security benefit gained from using scoped applications:",
    "options": [
      { "id": "A", "text": "Prevents changes to tables without explicit permission from IT", "correct": false },
      { "id": "B", "text": "Prevents third party integrations", "correct": false },
      { "id": "C", "text": "Limits accessibility to other applications in the instance", "correct": true },
      { "id": "D", "text": "Limits the number of update sets that can be applied", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 30,
    "type": "single",
    "question": "The CSM application has a feature that can be used to filter records in CSM-related tables which are accessible by users with CSM roles. This feature makes it unnecessary to create business logic for those persona access the data. What is this feature?",
    "options": [
      { "id": "A", "text": "CSM Query Rules", "correct": true },
      { "id": "B", "text": "Data Policies", "correct": false },
      { "id": "C", "text": "Filtered Lists", "correct": false },
      { "id": "D", "text": "Access Types", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 31,
    "type": "single",
    "question": "In Advanced Work Assignment, what does the overflow assignment capability do, if defined?",
    "options": [
      { "id": "A", "text": "When one support group reaches capacity the work item is automatically routed to another group", "correct": true },
      { "id": "B", "text": "Uses matching and assignment rules to send work items to the agent with the highest availability", "correct": false },
      { "id": "C", "text": "Routes cases to different groups based on their skill set and availability", "correct": false },
      { "id": "D", "text": "Uses matching and assignment rules to send work items to the agent with the most capacity", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 32,
    "type": "single",
    "question": "Which role must B2B and B2C customers obtain, at a MINIMUM, to access to a ServiceNow instance?",
    "options": [
      { "id": "A", "text": "External (snc_external)", "correct": true },
      { "id": "B", "text": "Account Contact (sn_customeservice.account_contact)", "correct": false },
      { "id": "C", "text": "Customer (sn_customerservice.customer)", "correct": false },
      { "id": "D", "text": "Case Creator (sn_customerservice.case_creator)", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 33,
    "type": "single",
    "question": "Which Flow Designer flow can be used to automatically close resolved cases if customers do not respond within a specified time?",
    "options": [
      { "id": "A", "text": "Close Cases in Resolved state", "correct": false },
      { "id": "B", "text": "Auto Close Resolved Cases", "correct": true },
      { "id": "C", "text": "Resolved to Close State", "correct": false },
      { "id": "D", "text": "Move Resolved Cases to Closed", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 34,
    "type": "single",
    "question": "What role can be assigned to employees who are not fulfillers, such as those in sales and services, or do not have other CSM-specific roles, but have a need to create cases on behalf of customers?",
    "options": [
      { "id": "A", "text": "Consumer (sn_customservice.consumer)", "correct": false },
      { "id": "B", "text": "Customer (sn_suctomservice.customer)", "correct": false },
      { "id": "C", "text": "External (snc_external)", "correct": false },
      { "id": "D", "text": "Proxy Contact (sn_customservice.proxy_contact)", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 35,
    "type": "multiple",
    "question": "Proactive Customer Service Operations works Event Management to proactively monitor and fix issues affecting customers. It can also trigger case workflow's and enable organizations to notify customers whose services or products are impacted by an outage or issue. What are the three main components that make up Proactive Customer Service Operations? (Choose three.)",
    "options": [
      { "id": "A", "text": "Proactive Prevention", "correct": false },
      { "id": "B", "text": "Service-Aware Install Base", "correct": true },
      { "id": "C", "text": "Service Reporting", "correct": false },
      { "id": "D", "text": "Proactive Case", "correct": true },
      { "id": "E", "text": "Service-Aware CMDB", "correct": false },
      { "id": "F", "text": "Service Monitoring", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 36,
    "type": "multiple",
    "question": "Which roles are considered external? (Choose two.)",
    "options": [
      { "id": "A", "text": "Consumer Support Agent (sn_customerservice.consumer_agent)", "correct": false },
      { "id": "B", "text": "Customer Admin (sn_customerservice.customer_admin)", "correct": true },
      { "id": "C", "text": "Partner Admin (sn_customerservice.partner_admin)", "correct": true },
      { "id": "D", "text": "Customer Service Agent (sn_customerservice_agent)", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 37,
    "type": "single",
    "question": "The default configuration automatically closes resolved Cases after how many days?",
    "options": [
      { "id": "A", "text": "5 days", "correct": false },
      { "id": "B", "text": "Cases are not automatically closed by default", "correct": true },
      { "id": "C", "text": "3 days", "correct": false },
      { "id": "D", "text": "10 days", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 38,
    "type": "single",
    "question": "What do blue circles in the timeline of a case form represent?",
    "options": [
      { "id": "A", "text": "Triggered SLAs", "correct": false },
      { "id": "B", "text": "Activity updates", "correct": false },
      { "id": "C", "text": "Customer comments", "correct": false },
      { "id": "D", "text": "State changes", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 39,
    "type": "multiple",
    "question": "What are the different resource matching methods on the Matching Rule form? (Choose four.)",
    "options": [
      { "id": "A", "text": "History", "correct": false },
      { "id": "B", "text": "Scripted", "correct": true },
      { "id": "C", "text": "Advanced", "correct": true },
      { "id": "D", "text": "Simple", "correct": true },
      { "id": "E", "text": "Skill", "correct": false },
      { "id": "F", "text": "Selection Criteria", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 40,
    "type": "multiple",
    "question": "Which of the following child case states would cause parent - child case synchronization to fail? (Choose three.)",
    "options": [
      { "id": "A", "text": "Resolved", "correct": true },
      { "id": "B", "text": "In Progress", "correct": false },
      { "id": "C", "text": "Awaiting Info", "correct": false },
      { "id": "D", "text": "New", "correct": false },
      { "id": "E", "text": "Closed", "correct": true },
      { "id": "F", "text": "Cancelled", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 41,
    "type": "single",
    "question": "External customers can view the problem, change, and request records associated with their customer service cases from the Customer and Consumer Service Portals. Which of the following can they approve in relation to cases via the portals?",
    "options": [
      { "id": "A", "text": "Request Records and Escalations", "correct": false },
      { "id": "B", "text": "Change Records and Request Records", "correct": true },
      { "id": "C", "text": "Problem Records and Escalations", "correct": false },
      { "id": "D", "text": "Problem Records and Incident Records", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 42,
    "type": "multiple",
    "question": "Playbooks for CSM provide step-by-step guidance for resolving specific types of customer service cases. What are the three out-of-the-box playbooks for CSM? (Choose three.)",
    "options": [
      { "id": "A", "text": "Case playbook for Onboarding", "correct": true },
      { "id": "B", "text": "Case playbook for Services", "correct": false },
      { "id": "C", "text": "Case playbook for Product Support", "correct": true },
      { "id": "D", "text": "Case playbook for Complaints", "correct": true },
      { "id": "E", "text": "Case playbook for Billing", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 43,
    "type": "multiple",
    "question": "Based on which out-of-box attributes can Special handling Notes be applied to cases? (Choose three.)",
    "options": [
      { "id": "A", "text": "Service Contract", "correct": false },
      { "id": "B", "text": "Install Base Item", "correct": false },
      { "id": "C", "text": "Product", "correct": true },
      { "id": "D", "text": "Account", "correct": true },
      { "id": "E", "text": "Contact", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 44,
    "type": "single",
    "question": "As an agent you can report a knowledge gap, if you cannot find relevant articles that could help resolve a case. Which action is required to create the knowledge gap?",
    "options": [
      { "id": "A", "text": "Document the knowledge gap in the case work notes and escalate the case", "correct": false },
      { "id": "B", "text": "Post a question in one of the various Customer Service Management knowledge bases", "correct": false },
      { "id": "C", "text": "Use Related Links on the case form to report a knowledge gap", "correct": true },
      { "id": "D", "text": "Use the Create Knowledge button on the case form to report a knowledge gap", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 45,
    "type": "single",
    "question": "What feature does the Product Model and Catalog Items Relationship plugin enable?",
    "options": [
      { "id": "A", "text": "Agents are automatically proposed catalog items related to the chosen product on the case form", "correct": false },
      { "id": "B", "text": "Consumers can track what products they have purchased via the catalog", "correct": false },
      { "id": "C", "text": "It provides a contextual service catalog based on the customer's subscribed services", "correct": true },
      { "id": "D", "text": "Customer service managers can track the financial cost of customer's subscribed services and the related requests", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 46,
    "type": "single",
    "question": "What happens to a case whenever the state of one of the associated IT Service Management records (incident, problem, change) is updated?",
    "options": [
      { "id": "A", "text": "The case escalates to an assignment group as defined in the default escalation template", "correct": false },
      { "id": "B", "text": "The case work notes are updated automatically", "correct": true },
      { "id": "C", "text": "The case action status changes to Related Task Updated", "correct": false },
      { "id": "D", "text": "The case displays a special handling note highlighting the update", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 47,
    "type": "multiple",
    "question": "Application Scoping from a security perspective brings the following benefits: (Choose two.)",
    "options": [
      { "id": "A", "text": "Improves instance security by limiting access to other applications on the instance", "correct": true },
      { "id": "B", "text": "Scoped applications prevent versioning for complex instances", "correct": false },
      { "id": "C", "text": "Scoping hold the records and acts as a container for the desired CSM applications", "correct": true },
      { "id": "D", "text": "Scoped applications limits autonomy and control of all aspects of the CSM application", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 48,
    "type": "single",
    "question": "How can multiple service catalogs be made available on the Customer Service Portal?",
    "options": [
      { "id": "A", "text": "Include them in the list of service catalogs on the Customer Service Portal record", "correct": true },
      { "id": "B", "text": "Add them to the list of service catalogs in the Customer Service Portal header widget options", "correct": false },
      { "id": "C", "text": "Only the Customer Service service catalog can be used on the Customer Service Portal", "correct": false },
      { "id": "D", "text": "Create user criteria for each of the applicable service catalogs", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 49,
    "type": "single",
    "question": "Now Create provides a prescriptive methodology, leading practices, and accelerators to help with ServiceNow implementations and upgrades. How many sequential project phases and exit gates are there in the Now Create Methodology?",
    "options": [
      { "id": "A", "text": "Three", "correct": false },
      { "id": "B", "text": "Five", "correct": true },
      { "id": "C", "text": "Four", "correct": false },
      { "id": "D", "text": "Six", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 50,
    "type": "single",
    "question": "From which one of the following can an agent create a CSM Case:",
    "options": [
      { "id": "A", "text": "Human Resource Application", "correct": false },
      { "id": "B", "text": "Incident Management", "correct": false },
      { "id": "C", "text": "Chat", "correct": true },
      { "id": "D", "text": "Special Handling Note", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 51,
    "type": "single",
    "question": "Using the out-of-the-box major issue management process flow, a consumer service agent proposes an existing case in the Open state as a major case candidate. The major case candidate has a consumer defined and is approved by the customer service manager What happens to the major case candidate?",
    "options": [
      { "id": "A", "text": "The major case candidate becomes a major case", "correct": false },
      { "id": "B", "text": "A new major case is created and the major case candidate is added as a child to the major case", "correct": true },
      { "id": "C", "text": "The major case candidate requires an approval from the major issue manager", "correct": false },
      { "id": "D", "text": "The major case candidate is closed and a new major case is created", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 52,
    "type": "multiple",
    "question": "What types of escalation templates can be created? (Choose two.)",
    "options": [
      { "id": "A", "text": "Case", "correct": true },
      { "id": "B", "text": "Sold Product", "correct": false },
      { "id": "C", "text": "Consumer", "correct": false },
      { "id": "D", "text": "Account", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 53,
    "type": "multiple",
    "question": "What are the recommended good practices when running implementation workshops? (Choose three.)",
    "options": [
      { "id": "A", "text": "Give the customers the data they need so they can make an informed decision", "correct": true },
      { "id": "B", "text": "Any financial implication of a decision should be handled by the delivery and sales team", "correct": false },
      { "id": "C", "text": "Enforce customers to adapt their processes towards the baseline processes", "correct": false },
      { "id": "D", "text": "Engage with customers to gain deep understanding of their organization", "correct": true },
      { "id": "E", "text": "Guide the customer toward industry best practices", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 54,
    "type": "single",
    "question": "What is the specific type of catalog item called that allows users to create task-based records, such as case records, from the Service Catalog?",
    "options": [
      { "id": "A", "text": "Request Item", "correct": false },
      { "id": "B", "text": "Record Producer", "correct": true },
      { "id": "C", "text": "Catalog Processor", "correct": false },
      { "id": "D", "text": "Case Template", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 55,
    "type": "single",
    "question": "Out-of-box, which functionality handles state transitioning for case management?",
    "options": [
      { "id": "A", "text": "Workflows", "correct": false },
      { "id": "B", "text": "State Flows", "correct": true },
      { "id": "C", "text": "Business Rules", "correct": false },
      { "id": "D", "text": "Flows", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 56,
    "type": "multiple",
    "question": "Which of the following are benefits of customer access management? (Choose two.)",
    "options": [
      { "id": "A", "text": "It defaults the responsibility for access management to the customer service agent.", "correct": false },
      { "id": "B", "text": "It increases security by automatically providing access to case information based on account hierarchy", "correct": false },
      { "id": "C", "text": "It increases automation by automatically granting access to cases based on access to sold product", "correct": true },
      { "id": "D", "text": "It improves the customer experience by enabling related parties to track and collaborate on cases.", "correct": true },
      { "id": "E", "text": "It defaults the responsibility for access management to the customer", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 57,
    "type": "multiple",
    "question": "What are the advantages of leading indicators over lagging indicators? (Choose two.)",
    "options": [
      { "id": "A", "text": "Hard to influence", "correct": false },
      { "id": "B", "text": "Prospective", "correct": true },
      { "id": "C", "text": "Retrospective", "correct": false },
      { "id": "D", "text": "Easy to influence", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 58,
    "type": "single",
    "question": "Customer Service Management Administrators can delegate Contact Administration activities to specific contacts within accounts by assigning specific roles to one or more users. Which of the following roles, if assigned, would allow the user to create contacts?",
    "options": [
      { "id": "A", "text": "Customer case manager (sn_customerservice.customer_case_manager)", "correct": false },
      { "id": "B", "text": "Customer account manager (sn_customerservice.customer_account_manager)", "correct": false },
      { "id": "C", "text": "Customer admin (sn_customerservice.customer_admln)", "correct": true },
      { "id": "D", "text": "Customer (sn_customerservice.customer)", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 59,
    "type": "single",
    "question": "What is knowledge article versioning?",
    "options": [
      { "id": "A", "text": "A content tracker for knowledge articles", "correct": false },
      { "id": "B", "text": "A knowledge article publishing guide", "correct": false },
      { "id": "C", "text": "The ability to manage and track article updates", "correct": true },
      { "id": "D", "text": "A knowledge article numbering guide", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 60,
    "type": "single",
    "question": "Service providers use business models to support their various customers. What type of customer is supported with the Business-to-Consumer (B2C) model?",
    "options": [
      { "id": "A", "text": "Individuals", "correct": true },
      { "id": "B", "text": "Partners", "correct": false },
      { "id": "C", "text": "Contacts", "correct": false },
      { "id": "D", "text": "Accounts", "correct": false }
    ],
    "explanation": ""
  }
];

function normalizeType(t){ return t === 'multiple' ? 'multi' : t; }
const QUESTIONS_BANK = QUESTIONS_BANK_RAW.map(q => ({ ...q, type: normalizeType(q.type) }));

/* ==============================
 * ESTADO / PERSIST√äNCIA
 * ============================== */
const QUIZ_SESSION_KEY = 'quizActiveSession_v3';
let quizState = {
  startTime: null,
  endTime: null,
  currentIndex: 0,
  sequence: [],
  answers: {}, // single/multi: { selected:Set }, matching: { pairs:{} }
  locked: {},
  reviewMode: false
};
const appRoot = document.getElementById("appRoot");

/* Persist√™ncia */
function saveSession() {
  if (quizState.endTime) return;
  try {
    const serializable = {
      startTime: quizState.startTime,
      currentIndex: quizState.currentIndex,
      sequence: quizState.sequence,
      answers: Object.fromEntries(
        Object.entries(quizState.answers).map(([qid, val]) => {
          if (val.selected instanceof Set) return [qid, { selected: Array.from(val.selected) }];
          return [qid, { pairs: val.pairs || {} }];
        })
      ),
      locked: quizState.locked
    };
    localStorage.setItem(QUIZ_SESSION_KEY, JSON.stringify(serializable));
  } catch(e){ console.warn("Falha salvar sess√£o", e); }
}
function restoreSessionIfAny() {
  try {
    const raw = localStorage.getItem(QUIZ_SESSION_KEY);
    if(!raw) return false;
    const data = JSON.parse(raw);
    if(!Array.isArray(data.sequence)) return false;
    quizState.startTime = data.startTime || Date.now();
    quizState.currentIndex = data.currentIndex || 0;
    quizState.sequence = data.sequence;
    quizState.answers = {};
    if (data.answers) {
      Object.entries(data.answers).forEach(([qid,val])=>{
        if(val.selected) quizState.answers[qid]={selected:new Set(val.selected)};
        else if(val.pairs) quizState.answers[qid]={pairs:{...val.pairs}};
      });
    }
    quizState.locked = data.locked || {};
    return true;
  } catch(e){ console.warn("Falha restaurar sess√£o", e); return false; }
}
function clearSession(){ localStorage.removeItem(QUIZ_SESSION_KEY); }

/* Utilidades */
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function formatDuration(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${m}m ${r.toString().padStart(2,'0')}s`; }
function getCurrentQuestion(){ return quizState.sequence[quizState.currentIndex]; }

function initQuiz(){
  clearSession();
  quizState.startTime = Date.now();
  quizState.endTime = null;
  quizState.currentIndex = 0;
  quizState.answers = {};
  quizState.locked = {};
  quizState.reviewMode = false;
  quizState.sequence = shuffle(QUESTIONS_BANK.map(q=>{
    if(q.type==='matching'){
      return {
        ...q,
        left: shuffle(q.left.map(l=>({...l}))),
        right: shuffle(q.right.map(r=>({...r})))
      };
    }
    return { ...q, options: shuffle(q.options.map(o=>({...o}))) };
  }));
  renderLayout();
  renderQuestion();
  saveSession();
}

function countStats(){
  let correct=0, incorrect=0, skipped=0;
  quizState.sequence.forEach(q=>{
    const ans=quizState.answers[q.id];
    if(!ans || !quizState.locked[q.id]) { skipped++; return; }
    let isCorrect=false;
    if(q.type==='matching'){
      const pairs = ans.pairs || {};
      isCorrect = q.left.every(l=> pairs[l.id] === q.answerMap[l.id]);
    } else {
      const selected=ans.selected;
      const correctSet=new Set(q.options.filter(o=>o.correct).map(o=>o.id));
      isCorrect = selected.size===correctSet.size && Array.from(selected).every(id=>correctSet.has(id));
    }
    if(isCorrect) correct++; else incorrect++;
  });
  return {correct, incorrect, skipped, total:quizState.sequence.length};
}

/* Layout / Timer */
let timerInterval=null;
function renderLayout(){
  appRoot.innerHTML=`
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Servicenow CIS-CSM Exam 2</h5>
      <div>
  <a href="./home.html" class="btn btn-sm btn-outline-primary me-2">Home</a>
  <button class="btn btn-sm btn-outline-danger me-2" onclick="finishQuiz()">Finalizar Teste</button>
        <span class="small text-muted" id="timerSpan">00:00</span>
      </div>
    </div>
    <div class="progress mb-3">
      <div class="progress-bar" id="progressBar" style="width:0%"></div>
    </div>
    <div id="questionContainer"></div>
  `;
  startTimer();
}
function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    if(quizState.endTime){ clearInterval(timerInterval); return; }
    const diff=Date.now()-quizState.startTime;
    const s=Math.floor(diff/1000);
    const m=Math.floor(s/60);
    const r=s%60;
    const el=document.getElementById('timerSpan');
    if(el) el.textContent=`${m.toString().padStart(2,'0')}:${r.toString().padStart(2,'0')}`;
  },1000);
}

/* Render quest√£o */
function renderQuestion(){
  const q=getCurrentQuestion();
  const container=document.getElementById("questionContainer");
  if(!q || !container) return;
  const idx=quizState.currentIndex+1;
  const total=quizState.sequence.length;
  const isLocked=!!quizState.locked[q.id];
  const progressBar=document.getElementById("progressBar");
  if(progressBar) progressBar.style.width = `${((idx-1)/total)*100}%`;

  let answeredSet, pairs;
  if(q.type==='matching'){
    pairs = quizState.answers[q.id]?.pairs || {};
  } else {
    answeredSet = quizState.answers[q.id]?.selected || new Set();
  }

  // status geral
  let statusAlertHTML='';
  if(isLocked){
    let isCorrect=false;
    if(q.type==='matching'){
      isCorrect = q.left.every(l=> (pairs||{})[l.id] === q.answerMap[l.id]);
    } else {
      const correctSet=new Set(q.options.filter(o=>o.correct).map(o=>o.id));
      isCorrect = answeredSet.size===correctSet.size && Array.from(answeredSet).every(id=>correctSet.has(id));
    }
    statusAlertHTML = `
      <div class="mb-3">
        <div class="alert ${isCorrect?'alert-success':'alert-danger'} question-status-alert mb-0 py-2 px-3">
          <strong>${isCorrect?'Correta':'Incorreta'}:</strong>
          ${isCorrect?'Voc√™ acertou esta quest√£o.':'Esta quest√£o foi respondida incorretamente.'}
        </div>
      </div>
    `;
  }

  let bodyHTML='';
  if(q.type==='matching'){
    bodyHTML = `
      <h6 class="mb-3">${q.question}</h6>
      ${statusAlertHTML}
      ${renderMatchingQuestion(q, pairs, isLocked)}
    `;
  } else {
    const correctNeeded = q.type==='multi' ? q.options.filter(o=>o.correct).length : 1;
    bodyHTML = `
      <h6 class="mb-3">${q.question} ${q.type==='multi'?`<span class="text-muted small">(Escolha ${correctNeeded})</span>`:''}</h6>
      ${statusAlertHTML}
      <div id="optionsWrapper">
        ${q.options.map(opt=>{
          const selected=answeredSet.has(opt.id);
            const classes=["p-3","mb-2","border","rounded","option-card","d-flex","align-items-start"];
            if(selected) classes.push("selected");
            if(isLocked){
              if(selected && opt.correct) classes.push("correct-user");
              else if(!selected && opt.correct) classes.push("correct");
              else if(selected && !opt.correct) classes.push("incorrect-user");
            }
            return `
              <div class="${classes.join(' ')}" onclick="toggleSelect('${q.id}','${opt.id}')">
                <div class="me-3 mt-1">
                  ${q.type==='single'
                    ? `<input type="radio" name="q_${q.id}" ${selected?'checked':''} ${isLocked?'disabled':''}/>`
                    : `<input type="checkbox" ${selected?'checked':''} ${isLocked?'disabled':''}/>`}
                </div>
                <div class="flex-grow-1">
                  <div class="fw-semibold">${HIDE_OPTION_IDS ? opt.text : `${opt.id}. ${opt.text}`}</div>
                  ${isLocked ? renderOptionBadge(q,opt,selected):''}
                </div>
              </div>
            `;
        }).join('')}
      </div>
    `;
  }

  container.innerHTML = `
    <div class="mb-2 question-header-mini">Quest√£o ${idx} de ${total}</div>
    ${bodyHTML}
    <div id="feedbackZone"></div>
    <div class="mt-3 d-flex justify-content-end gap-2 flex-wrap">
      ${!isLocked
        ? `${idx>1?'<button class="btn btn-outline-secondary" onclick="goPrev()">Voltar</button>':''}
           <button class="btn btn-success" id="submitBtn" disabled onclick="evaluateCurrent()">Confirmar Resposta</button>`
        : `${idx>1?'<button class="btn btn-outline-secondary" onclick="goPrev()">Voltar</button>':''}
           <button class="btn btn-primary" onclick="goNextAfterLocked()">${idx===total?'Resultados':'Pr√≥xima >'}</button>`
      }
    </div>
  `;

  if(isLocked && q.explanation){
    document.getElementById('feedbackZone').innerHTML = `
      <div class="feedback-area mt-3 small text-muted">
        <strong>Explica√ß√£o:</strong> ${q.explanation}
      </div>
    `;
  }

  updateSubmitButtonState();
}

/* Matching render */
function renderMatchingQuestion(q, pairs, isLocked){
  return `
    <div class="mb-2 small text-muted">Associe cada defini√ß√£o ao papel correto.</div>
    <div id="matchingWrapper">
      ${q.left.map(l=>{
        const chosen = pairs[l.id] || '';
        let rowClass='matching-row';
        let badgeHTML='';
        if(isLocked){
          const correctId=q.answerMap[l.id];
          const isCorrect = chosen === correctId;
          rowClass += isCorrect ? ' correct' : ' incorrect';
          badgeHTML = `<span class="badge ${isCorrect?'bg-success-subtle text-success border border-success':'bg-danger-subtle text-danger border border-danger'} matching-badge ms-2">
            ${isCorrect?'Correto':'Incorreto'}${!isCorrect ? ' (Correto: '+ rightTextById(q, correctId) +')':''}
          </span>`;
        }
        return `
          <div class="${rowClass}" data-left="${l.id}">
            <div class="matching-left-text">${l.text}</div>
            <div>
              <select class="form-select form-select-sm" ${isLocked?'disabled':''}
                onchange="setMatchPair('${q.id}','${l.id}', this.value)">
                <option value="">-- Selecione --</option>
                ${q.right.map(r=>{
                  const selected = r.id === chosen ? 'selected':'';
                  let disable = '';
                  if(!isLocked && chosen !== r.id && Object.values(pairs).includes(r.id)) disable='disabled';
                  return `<option value="${r.id}" ${selected} ${disable}>${HIDE_OPTION_IDS ? r.text : (r.id + ' - ' + r.text)}</option>`;
                }).join('')}
              </select>
              ${badgeHTML}
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/* Badges single/multi */
function renderOptionBadge(q,opt,userSelected){
  if(q.type==='multi'){
    if(userSelected && opt.correct) return `<span class="badge bg-success-subtle text-success border border-success badge-label mt-1">Sua sele√ß√£o est√° correta</span>`;
    if(!userSelected && opt.correct) return `<span class="badge bg-success-subtle text-success border border-success badge-label mt-1">Sele√ß√£o correta</span>`;
    if(userSelected && !opt.correct) return `<span class="badge bg-danger-subtle text-danger border border-danger badge-label mt-1">Sua sele√ß√£o est√° incorreta</span>`;
    return '';
  } else {
    if(opt.correct && userSelected) return `<span class="badge bg-success-subtle text-success border border-success badge-label mt-1">Resposta correta</span>`;
    if(opt.correct && !userSelected) return `<span class="badge bg-success-subtle text-success border border-success badge-label mt-1">Resposta correta</span>`;
    if(userSelected && !opt.correct) return `<span class="badge bg-danger-subtle text-danger border border-danger badge-label mt-1">Incorreta</span>`;
    return '';
  }
}

/* Estado bot√£o confirmar */
function updateSubmitButtonState(){
  const q=getCurrentQuestion();
  const btn=document.getElementById("submitBtn");
  if(!btn) return;
  if(q.type==='matching'){
    const ans=quizState.answers[q.id];
    const filled = ans && ans.pairs ? Object.values(ans.pairs).filter(v=>v).length : 0;
    btn.disabled = filled !== q.left.length;
  } else {
    const ans=quizState.answers[q.id];
    btn.disabled = !(ans && ans.selected.size>0);
  }
}

/* Intera√ß√£o single/multi */
function toggleSelect(qid, optId){
  const q=quizState.sequence.find(q=>q.id==qid);
  if(!q || q.type==='matching' || quizState.locked[q.id]) return;
  if(!quizState.answers[q.id]) quizState.answers[q.id]={selected:new Set()};
  const sel=quizState.answers[q.id].selected;
  if(q.type==='single'){ sel.clear(); sel.add(optId); }
  else {
    if(sel.has(optId)) sel.delete(optId); else sel.add(optId);
  }
  renderQuestion(); saveSession();
}

/* Intera√ß√£o matching */
function setMatchPair(qid,leftId,rightId){
  const q=quizState.sequence.find(q=>q.id==qid);
  if(!q || q.type!=='matching' || quizState.locked[q.id]) return;
  if(!quizState.answers[q.id]) quizState.answers[q.id]={pairs:{}};
  const pairs=quizState.answers[q.id].pairs;
  if(rightId==='') delete pairs[leftId];
  else {
    Object.entries(pairs).forEach(([l,r])=>{
      if(r===rightId && l!==leftId) delete pairs[l];
    });
    pairs[leftId]=rightId;
  }
  renderQuestion(); saveSession();
}

/* Avaliar */
function evaluateCurrent(){
  const q=getCurrentQuestion();
  if(q.type==='matching'){
    const ans=quizState.answers[q.id];
    if(!ans || Object.keys(ans.pairs).length < q.left.length) return;
    quizState.locked[q.id]=true;
  } else {
    const ans=quizState.answers[q.id];
    if(!ans || ans.selected.size===0) return;
    quizState.locked[q.id]=true;
  }
  if(q.explanation){
    document.getElementById("feedbackZone").innerHTML=`
      <div class="feedback-area mt-3 small text-muted">
        <strong>Explica√ß√£o:</strong> ${q.explanation}
      </div>
    `;
  }
  renderQuestion(); saveSession();
}

function goNextAfterLocked(){
  if(quizState.currentIndex === quizState.sequence.length-1) finishQuiz();
  else { quizState.currentIndex++; renderQuestion(); saveSession(); }
}
function goPrev(){
  if(quizState.currentIndex===0) return;
  quizState.currentIndex--; renderQuestion(); saveSession();
}

/* Resultados */
function finishQuiz(){
  quizState.endTime=Date.now();
  const stats=countStats();
  const duration=formatDuration(quizState.endTime-quizState.startTime);
  clearSession();
  const attemptsKey='quizAttempts';
  let attempts=parseInt(localStorage.getItem(attemptsKey)||'0',10);
  attempts++; localStorage.setItem(attemptsKey,attempts);
  const percent = stats.total? Math.round((stats.correct/stats.total)*100) : 0;

  appRoot.innerHTML=`
    <div class="mb-4">
      <h4 class="mb-0">Resultados do Quiz</h4>
      <div class="text-muted small">Tentativa ${attempts} ‚Ä¢ ${new Date().toLocaleString('pt-BR')}</div>
    </div>
    <div class="row g-4">
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body d-flex flex-column justify-content-center">
            <div class="donut-wrapper mb-3">
              <canvas id="resultDonut" width="160" height="160"></canvas>
              <div class="donut-center">${percent}%</div>
            </div>
            <div class="text-center small">
              <span class="me-2"><span class="badge bg-success">&nbsp;</span> Corretas: ${stats.correct}</span>
              <span class="me-2"><span class="badge bg-danger">&nbsp;</span> Incorretas: ${stats.incorrect}</span>
              <span><span class="badge bg-secondary">&nbsp;</span> Puladas: ${stats.skipped}</span>
            </div>
          </div>
          <div class="card-footer text-center">
            <strong>${stats.correct}/${stats.total}</strong> corretas<br/>Tempo: ${duration}
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card h-100">
          <div class="card-body">
            <p class="mb-3">Voc√™ concluiu o quiz. Revise ou refa√ßa para praticar novamente.</p>
            <ul class="list-group mb-3 small">
              <li class="list-group-item d-flex justify-content-between"><span>Total de quest√µes</span><strong>${stats.total}</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Corretas</span><strong class="text-success">${stats.correct}</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Incorretas</span><strong class="text-danger">${stats.incorrect}</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Puladas</span><strong class="text-secondary">${stats.skipped}</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Percentual</span><strong>${percent}%</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Dura√ß√£o</span><strong>${duration}</strong></li>
            </ul>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-primary" onclick="reviewQuestions()">Rever Quest√µes</button>
              <button class="btn btn-success" onclick="initQuiz()">Refazer (Randomizar)</button>
              <button class="btn btn-outline-secondary" onclick="toggleTheme()">Alternar Tema</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  drawDonut(stats.correct, stats.incorrect, stats.skipped);
}

/* Donut */
function drawDonut(correct, incorrect, skipped){
  const canvas=document.getElementById("resultDonut");
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const total=correct+incorrect+skipped||1;
  const data=[
    {value:correct,color:'#198754'},
    {value:incorrect,color:'#dc3545'},
    {value:skipped,color:'#6c757d'}
  ].filter(d=>d.value>0);
  let start=-Math.PI/2;
  data.forEach(d=>{
    const slice=(d.value/total)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(80,80);
    ctx.arc(80,80,80,start,start+slice);
    ctx.closePath();
    ctx.fillStyle=d.color;
    ctx.fill();
    start+=slice;
  });
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath(); ctx.arc(80,80,48,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation='source-over';
}

/* Revis√£o */
function reviewQuestions(){
  const stats=countStats();
  const blocks=quizState.sequence.map((q,i)=>{
    const ans=quizState.answers[q.id];
    let userCorrect=false;

    if(q.type==='matching'){
      const pairs = ans ? ans.pairs || {} : {};
      userCorrect = ans && q.left.every(l=> pairs[l.id] === q.answerMap[l.id]);
      return `
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between">
            <span><strong>Quest√£o ${i+1}:</strong> (Matching)</span>
            <span class="badge ${userCorrect?'bg-success':'bg-danger'}">${userCorrect?'Correta':'Incorreta'}</span>
          </div>
          <div class="card-body">
            <p class="mb-3">${q.question}</p>
            ${q.left.map(l=>{
              const chosen = (ans && ans.pairs)? ans.pairs[l.id] : '';
              const correctId = q.answerMap[l.id];
              const isRowCorrect = chosen === correctId;
              return `
                <div class="matching-row ${isRowCorrect?'correct':'incorrect'}">
                  <div class="matching-left-text">${l.text}</div>
                  <div class="small">
                    <div><strong>Selecionado:</strong> ${chosen ? rightTextById(q, chosen) : '(vazio)'}</div>
                    <div><strong>Correto:</strong> ${rightTextById(q, correctId)}</div>
                  </div>
                </div>
              `;
            }).join('')}
            ${q.explanation?`<div class="small text-muted"><strong>Explica√ß√£o:</strong> ${q.explanation}</div>`:''}
          </div>
        </div>
      `;
    } else {
      const selected=ans ? ans.selected : new Set();
      const correctSet=new Set(q.options.filter(o=>o.correct).map(o=>o.id));
      userCorrect = ans && selected.size===correctSet.size && Array.from(selected).every(id=>correctSet.has(id));
      return `
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between">
            <span><strong>Quest√£o ${i+1}:</strong> ${q.type==='multi'?'(Multi)':'(√önica)'}</span>
            <span class="badge ${userCorrect?'bg-success':'bg-danger'}">${userCorrect?'Correta':'Incorreta'}</span>
          </div>
          <div class="card-body">
            <p class="mb-3">${q.question}</p>
            ${q.options.map(o=>{
              let classes="p-2 px-3 mb-2 border rounded small";
              let badge='';
              const userSel=selected.has(o.id);
              if(o.correct && userSel){ classes+=" border-success bg-success-subtle"; badge='<span class="badge bg-success-subtle text-success border border-success badge-label">Sua sele√ß√£o correta</span>'; }
              else if(o.correct && !userSel){ classes+=" border-success bg-success-subtle"; badge='<span class="badge bg-success-subtle text-success border border-success badge-label">Resposta correta</span>'; }
              else if(!o.correct && userSel){ classes+=" border-danger bg-danger-subtle"; badge='<span class="badge bg-danger-subtle text-danger border border-danger badge-label">Selecionada (Incorreta)</span>'; }
              else { classes+=" border-light"; }
              return `<div class="${classes}">${HIDE_OPTION_IDS?o.text:`<strong>${o.id}.</strong> ${o.text}`}<br/>${badge}</div>`;
            }).join('')}
            ${q.explanation?`<div class="small text-muted"><strong>Explica√ß√£o:</strong> ${q.explanation}</div>`:''}
          </div>
        </div>
      `;
    }
  }).join('');

  appRoot.innerHTML=`
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Revis√£o das Quest√µes</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-success btn-sm" onclick="initQuiz()">Refazer</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="finishQuiz()">Voltar aos Resultados</button>
      </div>
    </div>
    <div class="mb-3 small">
      <span class="me-3"><span class="badge bg-success">&nbsp;</span> Corretas: ${stats.correct}</span>
      <span class="me-3"><span class="badge bg-danger">&nbsp;</span> Incorretas: ${stats.incorrect}</span>
      <span><span class="badge bg-secondary">&nbsp;</span> Puladas: ${stats.skipped}</span>
    </div>
    ${blocks}
  `;
}

/* Helpers right text */
function rightTextById(q, id){ const it=(q.right||[]).find(r=>r.id===id); return it?it.text:''; }

/* Tema */
const themeBtn=document.getElementById("themeBtn");
function toggleTheme(){
  const html=document.documentElement;
  const cur=html.getAttribute('data-bs-theme')||'light';
  const next=cur==='light'?'dark':'light';
  html.setAttribute('data-bs-theme',next);
  localStorage.setItem('quizTheme',next);
}
themeBtn.addEventListener('click',toggleTheme);
(function(){ const saved=localStorage.getItem('quizTheme'); if(saved) document.documentElement.setAttribute('data-bs-theme',saved); })();

/* Navega√ß√£o & exposi√ß√£o */
function goNextAfterLocked(){ if(quizState.currentIndex===quizState.sequence.length-1) finishQuiz(); else {quizState.currentIndex++; renderQuestion(); saveSession();} }
function goPrev(){ if(quizState.currentIndex===0) return; quizState.currentIndex--; renderQuestion(); saveSession(); }

window.toggleSelect=toggleSelect;
window.evaluateCurrent=evaluateCurrent;
window.finishQuiz=finishQuiz;
window.reviewQuestions=reviewQuestions;
window.goNextAfterLocked=goNextAfterLocked;
window.goPrev=goPrev;
window.toggleTheme=toggleTheme;
window.initQuiz=initQuiz;
window.setMatchPair=setMatchPair;

/* Start */
(function start(){
  if(restoreSessionIfAny()){ renderLayout(); renderQuestion(); startTimer(); }
  else initQuiz();
})();
</script>
</body>
</html>