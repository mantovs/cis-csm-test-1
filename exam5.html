<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
<meta charset="UTF-8" />
<title>CIS-CSM Hard Questions</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body { background:#fff; }
  .option-card { cursor:pointer; transition:.15s; }
  .option-card:not(.disabled):hover { border-color:#6f42c1; box-shadow:0 0 0 .15rem rgba(111,66,193,.15); }
  .option-card.selected { border-width:2px; border-color:#6f42c1; background:#f9f5ff; }
  .option-card.correct-user, .option-card.correct { border-color:#198754!important; background:#d1e7dd; }
  .option-card.incorrect-user { border-color:#dc3545!important; background:#f8d7da; }
  .badge-label { font-size:.65rem; letter-spacing:.5px; text-transform:uppercase; font-weight:600; }
  .feedback-area { animation:fadeIn .35s; }
  @keyframes fadeIn { from {opacity:0;transform:translateY(4px)} to {opacity:1;transform:translateY(0)} }
  .donut-wrapper { position:relative; width:160px; height:160px; margin:auto; }
  .donut-wrapper canvas { width:100%; height:100%; }
  .donut-center { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:1.3rem; }
  .question-header-mini { font-size:.8rem; color:#6c757d; text-transform:uppercase; letter-spacing:.5px; }
  .toggle-theme { position:fixed; bottom:1rem; right:1rem; z-index:1000; }
  .question-status-alert { font-size:.8rem; }

  /* Matching */
  .matching-row {
    display:flex;
    gap:1rem;
    align-items:flex-start;
    padding:.75rem .9rem;
    border:1px solid #dee2e6;
    border-radius:.5rem;
    margin-bottom:.6rem;
    background:#fff;
  }
  .matching-row select { min-width:150px; }
  .matching-row.correct { border-color:#198754; background:#d1e7dd; }
  .matching-row.incorrect { border-color:#dc3545; background:#f8d7da; }
  .matching-left-text { flex:1; }
  .matching-badge {
    font-size:.6rem;
    letter-spacing:.5px;
    font-weight:600;
    text-transform:uppercase;
  }
  @media (max-width: 576px){
    .matching-row { flex-direction:column; }
    .matching-row select { width:100%; }
  }

  #themeBtn{
    display: none;
  }
</style>
</head>
<body>
<div class="container py-4" id="appRoot"></div>
<button class="btn btn-outline-secondary btn-sm toggle-theme" id="themeBtn" title="Alternar Tema">üåì</button>

<script>
/* ==============================
 * CONFIG
 * ============================== */
const HIDE_OPTION_IDS = true; // Se quiser voltar a mostrar IDs (A., B., 1-, etc.) mude para false.

/* ==============================
 * QUEST√ïES (JSON BASE) - exemplo incluindo matching
 * ============================== */
const QUESTIONS_BANK_RAW = [{
        "id": 1,
        "type": "multiple",
        "question": "The Customer Support Portal default configuration provides the following channels to interact with customers? (Choose two.)",
        "options": [{
                "id": "A",
                "text": "Web",
                "correct": false
            },
            {
                "id": "B",
                "text": "Social",
                "correct": false
            },
            {
                "id": "C",
                "text": "Chat",
                "correct": true
            },
            {
                "id": "D",
                "text": "Email",
                "correct": true
            }
        ],
        "explanation": ""
    }, {
        "id": 2,
        "type": "matching",
        "question": "Match the definitions for roles relationships.",
        "left": [{
                "id": "A",
                "text": "A customer account, a partner, account, or both"
            },
            {
                "id": "B",
                "text": "A supported external customer that, sells and supports one or more customers"
            },
            {
                "id": "C",
                "text": "A member of an account"
            },
            {
                "id": "D",
                "text": "A person who purchases goods and services for personal UserActivation"
            }
        ],
        "right": [{
                "id": "1",
                "text": "Partner"
            },
            {
                "id": "2",
                "text": "Account"
            },
            {
                "id": "3",
                "text": "Contact"
            },
            {
                "id": "4",
                "text": "Consumer"
            }
        ],
        "answerMap": {
            "A": "2",
            "B": "1",
            "C": "3",
            "D": "4"
        },
        "explanation": ""
    },
    {
        "id": 3,
        "type": "multiple",
        "question": "What are features of Customer Service Management? (Choose four.)",
        "options": [{
                "id": "A",
                "text": "Timed Audits",
                "correct": false
            },
            {
                "id": "B",
                "text": "Service Entitlements",
                "correct": true
            },
            {
                "id": "C",
                "text": "Demand Management",
                "correct": false
            },
            {
                "id": "D",
                "text": "Service Prospecting",
                "correct": false
            },
            {
                "id": "E",
                "text": "Real-time SLAs",
                "correct": true
            },
            {
                "id": "F",
                "text": "Service Contracts",
                "correct": true
            },
            {
                "id": "G",
                "text": "Skills-based routing",
                "correct": true
            }
        ],
        "explanation": ""
    },
  {
    "id": 4,
    "type": "multiple",
    "question": "Which of the following are channels? (Choose two.)",
    "options": [
      { "id": "A", "text": "Contacts", "correct": false },
      { "id": "B", "text": "Web", "correct": true },
      { "id": "C", "text": "Chat", "correct": true },
      { "id": "D", "text": "Article", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 5,
    "type": "multiple",
    "question": "Which of the following functions can be completed when using the Field Service Management Application on a mobile device offline? (Choose three.)",
    "options": [
      { "id": "A", "text": "Manage requests", "correct": false },
      { "id": "B", "text": "Execute assigned tasks", "correct": true },
      { "id": "C", "text": "Close work orders", "correct": true },
      { "id": "D", "text": "Manage cases", "correct": false },
      { "id": "E", "text": "Manage assets", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 6,
    "type": "multiple",
    "question": "The available case types are: (Choose two.)",
    "options": [
      { "id": "A", "text": "Product Support", "correct": false },
      { "id": "B", "text": "Order", "correct": true },
      { "id": "C", "text": "Product", "correct": true },
      { "id": "D", "text": "Support", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 7,
    "type": "multiple",
    "question": "Users with the sn_customerservice.proxy_contact role can do which of the following? (Choose two.)",
    "options": [
      { "id": "A", "text": "Manage cases on behalf of customer service agents", "correct": false },
      { "id": "B", "text": "Create cases on behalf of customers", "correct": true },
      { "id": "C", "text": "Manage requests on behalf of customer service agents", "correct": false },
      { "id": "D", "text": "Create requests on behalf of customers", "correct": true },
      { "id": "E", "text": "Manage major incident communication on behalf of a customer service manager", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 8,
    "type": "multiple",
    "question": "What are the Forum User Types? (Choose three.)",
    "options": [
      { "id": "A", "text": "Admin", "correct": false },
      { "id": "B", "text": "Registered", "correct": true },
      { "id": "C", "text": "Public", "correct": true },
      { "id": "D", "text": "Custom", "correct": true },
      { "id": "E", "text": "Moderator", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 9,
    "type": "matching",
    "question": "Match the business rule to its function in the Self-Service Portal.",
    "left": [
      { "id": "A", "text": "After registration request submittal, shows info message to user" },
      { "id": "B", "text": "Shows message to remind users to enter a corret registration code" },
      { "id": "C", "text": "Validates registration code and assigns account based on the registration code" },
      { "id": "D", "text": "Checks if the registration is valid based on the user's email address" }
    ],
    "right": [
      { "id": "1", "text": "Display rule" },
      { "id": "2", "text": "Display request message" },
      { "id": "3", "text": "validate_registration" },
      { "id": "4", "text": "Update account based on reg code" }
    ],
    "answerMap": { "A": "2", "B": "1", "C": "4", "D": "3" },
    "explanation": ""
  },
  {
    "id": 10,
    "type": "multiple",
    "question": "An entitlement defines the types of support a customer receives. Entitlements are based on a number of standard fields such as product and asset. When Proactive Customer Service Operations is implemented which additional fields could be used? (Choose two.)",
    "options": [
      { "id": "A", "text": "Contact", "correct": false },
      { "id": "B", "text": "Configuration Item", "correct": false },
      { "id": "C", "text": "Business Service", "correct": false },
      { "id": "D", "text": "Install base item", "correct": true },
      { "id": "E", "text": "Sold product", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 11,
    "type": "multiple",
    "question": "What are the types of matching criteria for Customer Service? (Choose four.)",
    "options": [
      { "id": "A", "text": "Matching Skills", "correct": true },
      { "id": "B", "text": "Last Assigned", "correct": true },
      { "id": "C", "text": "Certifications", "correct": false },
      { "id": "D", "text": "Distance", "correct": false },
      { "id": "E", "text": "Assigned Cases", "correct": true },
      { "id": "F", "text": "Availability Today", "correct": true },
      { "id": "G", "text": "Partner Hours", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 12,
    "type": "multiple",
    "question": "What are the recommended good practices when running implementation workshops? (Choose three.)",
    "options": [
      { "id": "A", "text": "Give the customers the data they need so they can make an informed decision", "correct": true },
      { "id": "B", "text": "Any financial implication of a decision should be handled by the delivery and sales team", "correct": false },
      { "id": "C", "text": "Enforce customers to adapt their processes towards the baseline processes", "correct": false },
      { "id": "D", "text": "Engage with customers to gain deep understanding of their organization", "correct": true },
      { "id": "E", "text": "Guide the customer toward industry best practices", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 13,
    "type": "multiple",
    "question": "What are some of the influencing factors that will help determine the type of customer support desk structure required? (Choose four.)",
    "options": [
      { "id": "A", "text": "Knowledge and skills required for agents", "correct": true },
      { "id": "B", "text": "Geographical location of customer", "correct": true },
      { "id": "C", "text": "Languages spoken by agents", "correct": true },
      { "id": "D", "text": "Number and type of support tools available", "correct": false },
      { "id": "E", "text": "Number of customer service portals used", "correct": false },
      { "id": "F", "text": "Number of agents required", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 14,
    "type": "single",
    "question": "Customer Service Management Administrators can delegate Contact Administration activities to specific contacts within accounts by assigning specific roles to one or more users. Which of the following roles, if assigned, would allow the user to create contacts?",
    "options": [
      { "id": "A", "text": "Customer case manager (sn_customerservice.customer_case_manager)", "correct": false },
      { "id": "B", "text": "Customer account manager (sn_customerservice.customer_account_manager)", "correct": false },
      { "id": "C", "text": "Customer admin (sn_customerservice.customer_admln)", "correct": true },
      { "id": "D", "text": "Customer (sn_customerservice.customer)", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 15,
    "type": "multiple",
    "question": "Which roles are considered external? (Choose two.)",
    "options": [
      { "id": "A", "text": "Consumer Support Agent (sn_customerservice.consumer_agent)", "correct": false },
      { "id": "B", "text": "Customer Admin (sn_customerservice.customer_admin)", "correct": true },
      { "id": "C", "text": "Partner Admin (sn_customerservice.partner_admin)", "correct": true },
      { "id": "D", "text": "Customer Service Agent (sn_customerservice_agent)", "correct": false }
    ],
    "explanation": ""
  },
  {
    "id": 16,
    "type": "multiple",
    "question": "What types of escalation templates can be created? (Choose two.)",
    "options": [
      { "id": "A", "text": "Case", "correct": true },
      { "id": "B", "text": "Sold Product", "correct": false },
      { "id": "C", "text": "Consumer", "correct": false },
      { "id": "D", "text": "Account", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 17,
    "type": "multiple",
    "question": "Which ServiceNow applications can be integrated out-of-the-box with CSM? (Choose three.)",
    "options": [
      { "id": "A", "text": "Service Portfolio Management", "correct": true },
      { "id": "B", "text": "Project Management", "correct": true },
      { "id": "C", "text": "DevOps", "correct": false },
      { "id": "D", "text": "Risk Management", "correct": false },
      { "id": "E", "text": "ITOM Event Management", "correct": true }
    ],
    "explanation": ""
  },
  {
    "id": 18,
    "type": "multiple",
    "question": "Advance Work Assignment assigns work to agents based on their availability, capacity, and skills. Agent Affinity enhances the Advanced Work Assignment process by adding additional agent details organized by affinity type. Which of these are these affinity types? (Choose three.)",
    "options": [
      { "id": "A", "text": "Skill seniority", "correct": false },
      { "id": "B", "text": "Account team responsibility", "correct": true },
      { "id": "C", "text": "Historical", "correct": true },
      { "id": "D", "text": "Related task", "correct": true },
      { "id": "E", "text": "Product expertise", "correct": false }
    ],
    "explanation": ""
  }
];

function normalizeType(t){ return t === 'multiple' ? 'multi' : t; }
const QUESTIONS_BANK = QUESTIONS_BANK_RAW.map(q => ({ ...q, type: normalizeType(q.type) }));

/* ==============================
 * ESTADO / PERSIST√äNCIA
 * ============================== */
const QUIZ_SESSION_KEY = 'quizActiveSession_v3';
let quizState = {
  startTime: null,
  endTime: null,
  currentIndex: 0,
  sequence: [],
  answers: {}, // single/multi: { selected:Set }, matching: { pairs:{} }
  locked: {},
  reviewMode: false
};
const appRoot = document.getElementById("appRoot");

/* Persist√™ncia */
function saveSession() {
  if (quizState.endTime) return;
  try {
    const serializable = {
      startTime: quizState.startTime,
      currentIndex: quizState.currentIndex,
      sequence: quizState.sequence,
      answers: Object.fromEntries(
        Object.entries(quizState.answers).map(([qid, val]) => {
          if (val.selected instanceof Set) return [qid, { selected: Array.from(val.selected) }];
          return [qid, { pairs: val.pairs || {} }];
        })
      ),
      locked: quizState.locked
    };
    localStorage.setItem(QUIZ_SESSION_KEY, JSON.stringify(serializable));
  } catch(e){ console.warn("Falha salvar sess√£o", e); }
}
function restoreSessionIfAny() {
  try {
    const raw = localStorage.getItem(QUIZ_SESSION_KEY);
    if(!raw) return false;
    const data = JSON.parse(raw);
    if(!Array.isArray(data.sequence)) return false;
    quizState.startTime = data.startTime || Date.now();
    quizState.currentIndex = data.currentIndex || 0;
    quizState.sequence = data.sequence;
    quizState.answers = {};
    if (data.answers) {
      Object.entries(data.answers).forEach(([qid,val])=>{
        if(val.selected) quizState.answers[qid]={selected:new Set(val.selected)};
        else if(val.pairs) quizState.answers[qid]={pairs:{...val.pairs}};
      });
    }
    quizState.locked = data.locked || {};
    return true;
  } catch(e){ console.warn("Falha restaurar sess√£o", e); return false; }
}
function clearSession(){ localStorage.removeItem(QUIZ_SESSION_KEY); }

/* Utilidades */
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function formatDuration(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${m}m ${r.toString().padStart(2,'0')}s`; }
function getCurrentQuestion(){ return quizState.sequence[quizState.currentIndex]; }

function initQuiz(){
  clearSession();
  quizState.startTime = Date.now();
  quizState.endTime = null;
  quizState.currentIndex = 0;
  quizState.answers = {};
  quizState.locked = {};
  quizState.reviewMode = false;
  quizState.sequence = shuffle(QUESTIONS_BANK.map(q=>{
    if(q.type==='matching'){
      return {
        ...q,
        left: shuffle(q.left.map(l=>({...l}))),
        right: shuffle(q.right.map(r=>({...r})))
      };
    }
    return { ...q, options: shuffle(q.options.map(o=>({...o}))) };
  }));
  renderLayout();
  renderQuestion();
  saveSession();
}

function countStats(){
  let correct=0, incorrect=0, skipped=0;
  quizState.sequence.forEach(q=>{
    const ans=quizState.answers[q.id];
    if(!ans || !quizState.locked[q.id]) { skipped++; return; }
    let isCorrect=false;
    if(q.type==='matching'){
      const pairs = ans.pairs || {};
      isCorrect = q.left.every(l=> pairs[l.id] === q.answerMap[l.id]);
    } else {
      const selected=ans.selected;
      const correctSet=new Set(q.options.filter(o=>o.correct).map(o=>o.id));
      isCorrect = selected.size===correctSet.size && Array.from(selected).every(id=>correctSet.has(id));
    }
    if(isCorrect) correct++; else incorrect++;
  });
  return {correct, incorrect, skipped, total:quizState.sequence.length};
}

/* Layout / Timer */
let timerInterval=null;
function renderLayout(){
  appRoot.innerHTML=`
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Servicenow CIS-CSM Hard Questions</h5>
      <div>
  <a href="./home.html" class="btn btn-sm btn-outline-primary me-2">Home</a>
  <button class="btn btn-sm btn-outline-danger me-2" onclick="finishQuiz()">Finalizar Teste</button>
        <span class="small text-muted" id="timerSpan">00:00</span>
      </div>
    </div>
    <div class="progress mb-3">
      <div class="progress-bar" id="progressBar" style="width:0%"></div>
    </div>
    <div id="questionContainer"></div>
  `;
  startTimer();
}
function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    if(quizState.endTime){ clearInterval(timerInterval); return; }
    const diff=Date.now()-quizState.startTime;
    const s=Math.floor(diff/1000);
    const m=Math.floor(s/60);
    const r=s%60;
    const el=document.getElementById('timerSpan');
    if(el) el.textContent=`${m.toString().padStart(2,'0')}:${r.toString().padStart(2,'0')}`;
  },1000);
}

/* Render quest√£o */
function renderQuestion(){
  const q=getCurrentQuestion();
  const container=document.getElementById("questionContainer");
  if(!q || !container) return;
  const idx=quizState.currentIndex+1;
  const total=quizState.sequence.length;
  const isLocked=!!quizState.locked[q.id];
  const progressBar=document.getElementById("progressBar");
  if(progressBar) progressBar.style.width = `${((idx-1)/total)*100}%`;

  let answeredSet, pairs;
  if(q.type==='matching'){
    pairs = quizState.answers[q.id]?.pairs || {};
  } else {
    answeredSet = quizState.answers[q.id]?.selected || new Set();
  }

  // status geral
  let statusAlertHTML='';
  if(isLocked){
    let isCorrect=false;
    if(q.type==='matching'){
      isCorrect = q.left.every(l=> (pairs||{})[l.id] === q.answerMap[l.id]);
    } else {
      const correctSet=new Set(q.options.filter(o=>o.correct).map(o=>o.id));
      isCorrect = answeredSet.size===correctSet.size && Array.from(answeredSet).every(id=>correctSet.has(id));
    }
    statusAlertHTML = `
      <div class="mb-3">
        <div class="alert ${isCorrect?'alert-success':'alert-danger'} question-status-alert mb-0 py-2 px-3">
          <strong>${isCorrect?'Correta':'Incorreta'}:</strong>
          ${isCorrect?'Voc√™ acertou esta quest√£o.':'Esta quest√£o foi respondida incorretamente.'}
        </div>
      </div>
    `;
  }

  let bodyHTML='';
  if(q.type==='matching'){
    bodyHTML = `
      <h6 class="mb-3">${q.question}</h6>
      ${statusAlertHTML}
      ${renderMatchingQuestion(q, pairs, isLocked)}
    `;
  } else {
    const correctNeeded = q.type==='multi' ? q.options.filter(o=>o.correct).length : 1;
    bodyHTML = `
      <h6 class="mb-3">${q.question} ${q.type==='multi'?`<span class="text-muted small">(Escolha ${correctNeeded})</span>`:''}</h6>
      ${statusAlertHTML}
      <div id="optionsWrapper">
        ${q.options.map(opt=>{
          const selected=answeredSet.has(opt.id);
            const classes=["p-3","mb-2","border","rounded","option-card","d-flex","align-items-start"];
            if(selected) classes.push("selected");
            if(isLocked){
              if(selected && opt.correct) classes.push("correct-user");
              else if(!selected && opt.correct) classes.push("correct");
              else if(selected && !opt.correct) classes.push("incorrect-user");
            }
            return `
              <div class="${classes.join(' ')}" onclick="toggleSelect('${q.id}','${opt.id}')">
                <div class="me-3 mt-1">
                  ${q.type==='single'
                    ? `<input type="radio" name="q_${q.id}" ${selected?'checked':''} ${isLocked?'disabled':''}/>`
                    : `<input type="checkbox" ${selected?'checked':''} ${isLocked?'disabled':''}/>`}
                </div>
                <div class="flex-grow-1">
                  <div class="fw-semibold">${HIDE_OPTION_IDS ? opt.text : `${opt.id}. ${opt.text}`}</div>
                  ${isLocked ? renderOptionBadge(q,opt,selected):''}
                </div>
              </div>
            `;
        }).join('')}
      </div>
    `;
  }

  container.innerHTML = `
    <div class="mb-2 question-header-mini">Quest√£o ${idx} de ${total}</div>
    ${bodyHTML}
    <div id="feedbackZone"></div>
    <div class="mt-3 d-flex justify-content-end gap-2 flex-wrap">
      ${!isLocked
        ? `${idx>1?'<button class="btn btn-outline-secondary" onclick="goPrev()">Voltar</button>':''}
           <button class="btn btn-success" id="submitBtn" disabled onclick="evaluateCurrent()">Confirmar Resposta</button>`
        : `${idx>1?'<button class="btn btn-outline-secondary" onclick="goPrev()">Voltar</button>':''}
           <button class="btn btn-primary" onclick="goNextAfterLocked()">${idx===total?'Resultados':'Pr√≥xima >'}</button>`
      }
    </div>
  `;

  if(isLocked && q.explanation){
    document.getElementById('feedbackZone').innerHTML = `
      <div class="feedback-area mt-3 small text-muted">
        <strong>Explica√ß√£o:</strong> ${q.explanation}
      </div>
    `;
  }

  updateSubmitButtonState();
}

/* Matching render */
function renderMatchingQuestion(q, pairs, isLocked){
  return `
    <div class="mb-2 small text-muted">Associe cada defini√ß√£o ao papel correto.</div>
    <div id="matchingWrapper">
      ${q.left.map(l=>{
        const chosen = pairs[l.id] || '';
        let rowClass='matching-row';
        let badgeHTML='';
        if(isLocked){
          const correctId=q.answerMap[l.id];
          const isCorrect = chosen === correctId;
          rowClass += isCorrect ? ' correct' : ' incorrect';
          badgeHTML = `<span class="badge ${isCorrect?'bg-success-subtle text-success border border-success':'bg-danger-subtle text-danger border border-danger'} matching-badge ms-2">
            ${isCorrect?'Correto':'Incorreto'}${!isCorrect ? ' (Correto: '+ rightTextById(q, correctId) +')':''}
          </span>`;
        }
        return `
          <div class="${rowClass}" data-left="${l.id}">
            <div class="matching-left-text">${l.text}</div>
            <div>
              <select class="form-select form-select-sm" ${isLocked?'disabled':''}
                onchange="setMatchPair('${q.id}','${l.id}', this.value)">
                <option value="">-- Selecione --</option>
                ${q.right.map(r=>{
                  const selected = r.id === chosen ? 'selected':'';
                  let disable = '';
                  if(!isLocked && chosen !== r.id && Object.values(pairs).includes(r.id)) disable='disabled';
                  return `<option value="${r.id}" ${selected} ${disable}>${HIDE_OPTION_IDS ? r.text : (r.id + ' - ' + r.text)}</option>`;
                }).join('')}
              </select>
              ${badgeHTML}
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/* Badges single/multi */
function renderOptionBadge(q,opt,userSelected){
  if(q.type==='multi'){
    if(userSelected && opt.correct) return `<span class="badge bg-success-subtle text-success border border-success badge-label mt-1">Sua sele√ß√£o est√° correta</span>`;
    if(!userSelected && opt.correct) return `<span class="badge bg-success-subtle text-success border border-success badge-label mt-1">Sele√ß√£o correta</span>`;
    if(userSelected && !opt.correct) return `<span class="badge bg-danger-subtle text-danger border border-danger badge-label mt-1">Sua sele√ß√£o est√° incorreta</span>`;
    return '';
  } else {
    if(opt.correct && userSelected) return `<span class="badge bg-success-subtle text-success border border-success badge-label mt-1">Resposta correta</span>`;
    if(opt.correct && !userSelected) return `<span class="badge bg-success-subtle text-success border border-success badge-label mt-1">Resposta correta</span>`;
    if(userSelected && !opt.correct) return `<span class="badge bg-danger-subtle text-danger border border-danger badge-label mt-1">Incorreta</span>`;
    return '';
  }
}

/* Estado bot√£o confirmar */
function updateSubmitButtonState(){
  const q=getCurrentQuestion();
  const btn=document.getElementById("submitBtn");
  if(!btn) return;
  if(q.type==='matching'){
    const ans=quizState.answers[q.id];
    const filled = ans && ans.pairs ? Object.values(ans.pairs).filter(v=>v).length : 0;
    btn.disabled = filled !== q.left.length;
  } else {
    const ans=quizState.answers[q.id];
    btn.disabled = !(ans && ans.selected.size>0);
  }
}

/* Intera√ß√£o single/multi */
function toggleSelect(qid, optId){
  const q=quizState.sequence.find(q=>q.id==qid);
  if(!q || q.type==='matching' || quizState.locked[q.id]) return;
  if(!quizState.answers[q.id]) quizState.answers[q.id]={selected:new Set()};
  const sel=quizState.answers[q.id].selected;
  if(q.type==='single'){ sel.clear(); sel.add(optId); }
  else {
    if(sel.has(optId)) sel.delete(optId); else sel.add(optId);
  }
  renderQuestion(); saveSession();
}

/* Intera√ß√£o matching */
function setMatchPair(qid,leftId,rightId){
  const q=quizState.sequence.find(q=>q.id==qid);
  if(!q || q.type!=='matching' || quizState.locked[q.id]) return;
  if(!quizState.answers[q.id]) quizState.answers[q.id]={pairs:{}};
  const pairs=quizState.answers[q.id].pairs;
  if(rightId==='') delete pairs[leftId];
  else {
    Object.entries(pairs).forEach(([l,r])=>{
      if(r===rightId && l!==leftId) delete pairs[l];
    });
    pairs[leftId]=rightId;
  }
  renderQuestion(); saveSession();
}

/* Avaliar */
function evaluateCurrent(){
  const q=getCurrentQuestion();
  if(q.type==='matching'){
    const ans=quizState.answers[q.id];
    if(!ans || Object.keys(ans.pairs).length < q.left.length) return;
    quizState.locked[q.id]=true;
  } else {
    const ans=quizState.answers[q.id];
    if(!ans || ans.selected.size===0) return;
    quizState.locked[q.id]=true;
  }
  if(q.explanation){
    document.getElementById("feedbackZone").innerHTML=`
      <div class="feedback-area mt-3 small text-muted">
        <strong>Explica√ß√£o:</strong> ${q.explanation}
      </div>
    `;
  }
  renderQuestion(); saveSession();
}

function goNextAfterLocked(){
  if(quizState.currentIndex === quizState.sequence.length-1) finishQuiz();
  else { quizState.currentIndex++; renderQuestion(); saveSession(); }
}
function goPrev(){
  if(quizState.currentIndex===0) return;
  quizState.currentIndex--; renderQuestion(); saveSession();
}

/* Resultados */
function finishQuiz(){
  quizState.endTime=Date.now();
  const stats=countStats();
  const duration=formatDuration(quizState.endTime-quizState.startTime);
  clearSession();
  const attemptsKey='quizAttempts';
  let attempts=parseInt(localStorage.getItem(attemptsKey)||'0',10);
  attempts++; localStorage.setItem(attemptsKey,attempts);
  const percent = stats.total? Math.round((stats.correct/stats.total)*100) : 0;

  appRoot.innerHTML=`
    <div class="mb-4">
      <h4 class="mb-0">Resultados do Quiz</h4>
      <div class="text-muted small">Tentativa ${attempts} ‚Ä¢ ${new Date().toLocaleString('pt-BR')}</div>
    </div>
    <div class="row g-4">
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body d-flex flex-column justify-content-center">
            <div class="donut-wrapper mb-3">
              <canvas id="resultDonut" width="160" height="160"></canvas>
              <div class="donut-center">${percent}%</div>
            </div>
            <div class="text-center small">
              <span class="me-2"><span class="badge bg-success">&nbsp;</span> Corretas: ${stats.correct}</span>
              <span class="me-2"><span class="badge bg-danger">&nbsp;</span> Incorretas: ${stats.incorrect}</span>
              <span><span class="badge bg-secondary">&nbsp;</span> Puladas: ${stats.skipped}</span>
            </div>
          </div>
          <div class="card-footer text-center">
            <strong>${stats.correct}/${stats.total}</strong> corretas<br/>Tempo: ${duration}
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card h-100">
          <div class="card-body">
            <p class="mb-3">Voc√™ concluiu o quiz. Revise ou refa√ßa para praticar novamente.</p>
            <ul class="list-group mb-3 small">
              <li class="list-group-item d-flex justify-content-between"><span>Total de quest√µes</span><strong>${stats.total}</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Corretas</span><strong class="text-success">${stats.correct}</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Incorretas</span><strong class="text-danger">${stats.incorrect}</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Puladas</span><strong class="text-secondary">${stats.skipped}</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Percentual</span><strong>${percent}%</strong></li>
              <li class="list-group-item d-flex justify-content-between"><span>Dura√ß√£o</span><strong>${duration}</strong></li>
            </ul>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-primary" onclick="reviewQuestions()">Rever Quest√µes</button>
              <button class="btn btn-success" onclick="initQuiz()">Refazer (Randomizar)</button>
              <button class="btn btn-outline-secondary" onclick="toggleTheme()">Alternar Tema</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  drawDonut(stats.correct, stats.incorrect, stats.skipped);
}

/* Donut */
function drawDonut(correct, incorrect, skipped){
  const canvas=document.getElementById("resultDonut");
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const total=correct+incorrect+skipped||1;
  const data=[
    {value:correct,color:'#198754'},
    {value:incorrect,color:'#dc3545'},
    {value:skipped,color:'#6c757d'}
  ].filter(d=>d.value>0);
  let start=-Math.PI/2;
  data.forEach(d=>{
    const slice=(d.value/total)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(80,80);
    ctx.arc(80,80,80,start,start+slice);
    ctx.closePath();
    ctx.fillStyle=d.color;
    ctx.fill();
    start+=slice;
  });
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath(); ctx.arc(80,80,48,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation='source-over';
}

/* Revis√£o */
function reviewQuestions(){
  const stats=countStats();
  const blocks=quizState.sequence.map((q,i)=>{
    const ans=quizState.answers[q.id];
    let userCorrect=false;

    if(q.type==='matching'){
      const pairs = ans ? ans.pairs || {} : {};
      userCorrect = ans && q.left.every(l=> pairs[l.id] === q.answerMap[l.id]);
      return `
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between">
            <span><strong>Quest√£o ${i+1}:</strong> (Matching)</span>
            <span class="badge ${userCorrect?'bg-success':'bg-danger'}">${userCorrect?'Correta':'Incorreta'}</span>
          </div>
          <div class="card-body">
            <p class="mb-3">${q.question}</p>
            ${q.left.map(l=>{
              const chosen = (ans && ans.pairs)? ans.pairs[l.id] : '';
              const correctId = q.answerMap[l.id];
              const isRowCorrect = chosen === correctId;
              return `
                <div class="matching-row ${isRowCorrect?'correct':'incorrect'}">
                  <div class="matching-left-text">${l.text}</div>
                  <div class="small">
                    <div><strong>Selecionado:</strong> ${chosen ? rightTextById(q, chosen) : '(vazio)'}</div>
                    <div><strong>Correto:</strong> ${rightTextById(q, correctId)}</div>
                  </div>
                </div>
              `;
            }).join('')}
            ${q.explanation?`<div class="small text-muted"><strong>Explica√ß√£o:</strong> ${q.explanation}</div>`:''}
          </div>
        </div>
      `;
    } else {
      const selected=ans ? ans.selected : new Set();
      const correctSet=new Set(q.options.filter(o=>o.correct).map(o=>o.id));
      userCorrect = ans && selected.size===correctSet.size && Array.from(selected).every(id=>correctSet.has(id));
      return `
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between">
            <span><strong>Quest√£o ${i+1}:</strong> ${q.type==='multi'?'(Multi)':'(√önica)'}</span>
            <span class="badge ${userCorrect?'bg-success':'bg-danger'}">${userCorrect?'Correta':'Incorreta'}</span>
          </div>
          <div class="card-body">
            <p class="mb-3">${q.question}</p>
            ${q.options.map(o=>{
              let classes="p-2 px-3 mb-2 border rounded small";
              let badge='';
              const userSel=selected.has(o.id);
              if(o.correct && userSel){ classes+=" border-success bg-success-subtle"; badge='<span class="badge bg-success-subtle text-success border border-success badge-label">Sua sele√ß√£o correta</span>'; }
              else if(o.correct && !userSel){ classes+=" border-success bg-success-subtle"; badge='<span class="badge bg-success-subtle text-success border border-success badge-label">Resposta correta</span>'; }
              else if(!o.correct && userSel){ classes+=" border-danger bg-danger-subtle"; badge='<span class="badge bg-danger-subtle text-danger border border-danger badge-label">Selecionada (Incorreta)</span>'; }
              else { classes+=" border-light"; }
              return `<div class="${classes}">${HIDE_OPTION_IDS?o.text:`<strong>${o.id}.</strong> ${o.text}`}<br/>${badge}</div>`;
            }).join('')}
            ${q.explanation?`<div class="small text-muted"><strong>Explica√ß√£o:</strong> ${q.explanation}</div>`:''}
          </div>
        </div>
      `;
    }
  }).join('');

  appRoot.innerHTML=`
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Revis√£o das Quest√µes</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-success btn-sm" onclick="initQuiz()">Refazer</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="finishQuiz()">Voltar aos Resultados</button>
      </div>
    </div>
    <div class="mb-3 small">
      <span class="me-3"><span class="badge bg-success">&nbsp;</span> Corretas: ${stats.correct}</span>
      <span class="me-3"><span class="badge bg-danger">&nbsp;</span> Incorretas: ${stats.incorrect}</span>
      <span><span class="badge bg-secondary">&nbsp;</span> Puladas: ${stats.skipped}</span>
    </div>
    ${blocks}
  `;
}

/* Helpers right text */
function rightTextById(q, id){ const it=(q.right||[]).find(r=>r.id===id); return it?it.text:''; }

/* Tema */
const themeBtn=document.getElementById("themeBtn");
function toggleTheme(){
  const html=document.documentElement;
  const cur=html.getAttribute('data-bs-theme')||'light';
  const next=cur==='light'?'dark':'light';
  html.setAttribute('data-bs-theme',next);
  localStorage.setItem('quizTheme',next);
}
themeBtn.addEventListener('click',toggleTheme);
(function(){ const saved=localStorage.getItem('quizTheme'); if(saved) document.documentElement.setAttribute('data-bs-theme',saved); })();

/* Navega√ß√£o & exposi√ß√£o */
function goNextAfterLocked(){ if(quizState.currentIndex===quizState.sequence.length-1) finishQuiz(); else {quizState.currentIndex++; renderQuestion(); saveSession();} }
function goPrev(){ if(quizState.currentIndex===0) return; quizState.currentIndex--; renderQuestion(); saveSession(); }

window.toggleSelect=toggleSelect;
window.evaluateCurrent=evaluateCurrent;
window.finishQuiz=finishQuiz;
window.reviewQuestions=reviewQuestions;
window.goNextAfterLocked=goNextAfterLocked;
window.goPrev=goPrev;
window.toggleTheme=toggleTheme;
window.initQuiz=initQuiz;
window.setMatchPair=setMatchPair;

/* Start */
(function start(){
  if(restoreSessionIfAny()){ renderLayout(); renderQuestion(); startTimer(); }
  else initQuiz();
})();
</script>
</body>
</html>